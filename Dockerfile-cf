FROM node:20.18.0

WORKDIR /app

RUN corepack enable

COPY package.json pnpm-lock.yaml ./

# Install dependencies with pnpm (corepack will handle pnpm installation)
RUN corepack install && pnpm install

# Install wrangler globally
RUN npm install -g wrangler

COPY . .

RUN tr -d '\r' < bindings. sh > bindings.tmp && \
    mv bindings.tmp bindings.sh && \
    chmod +x bindings.sh

RUN pnpm run build

EXPOSE 5173

ENV NODE_ENV=production \
    RUNNING_IN_DOCKER=true

CMD ["pnpm", "run", "dockerstart"]
